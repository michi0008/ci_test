name: CI Risk Assessment

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'risk-assessment/**'
      - 'pocvec/**'
      - '.github/workflows/ci-risk-assessment.yaml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

env:
  PYTHON_VERSION: '3.13'

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install dependencies
        working-directory: ./risk-assessment
        run: |
          uv sync --dev

      - name: Run linting
        working-directory: ./risk-assessment
        run: |
          echo "::group::Running ruff check"
          uv run ruff check . --output-format=github
          echo "::endgroup::"

          echo "::group::Running ruff format check"
          uv run ruff format --check .
          echo "::endgroup::"

      - name: Run type checking
        working-directory: ./risk-assessment
        run: |
          echo "::group::Running mypy"
          uv run mypy . || true  # åž‹ãƒã‚§ãƒƒã‚¯ã¯è­¦å‘Šãƒ¬ãƒ™ãƒ«
          echo "::endgroup::"

      - name: Generate code quality summary
        if: always()
        run: |
          echo "## ðŸ” Code Quality Results - Risk Assessment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linting & Formatting" >> $GITHUB_STEP_SUMMARY
          echo "- **Ruff Check**: ${{ steps.ruff-check.outcome || 'completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ruff Format**: ${{ steps.ruff-format.outcome || 'completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **MyPy**: ${{ steps.mypy.outcome || 'completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code quality checks completed for risk-assessment" >> $GITHUB_STEP_SUMMARY

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (test)
        id: docker-build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./risk-assessment/Dockerfile
          push: false
          load: true
          tags: risk-assessment:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify Docker image
        run: |
          echo "Verifying Docker image was built successfully..."
          docker images risk-assessment:test
          if ! docker images risk-assessment:test --format "table {{.Repository}}:{{.Tag}}" | grep -q "risk-assessment:test"; then
            echo "âŒ Docker image build failed"
            exit 1
          fi
          echo "âœ… Docker image built successfully"

      - name: Generate build summary
        if: always()
        run: |
          echo "## ðŸ³ Docker Build Test Results - Risk Assessment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.docker-build.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: risk-assessment:test" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.docker-build.outcome }}" == "success" ]; then
            echo "âœ… Docker image built successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Docker image build failed" >> $GITHUB_STEP_SUMMARY
          fi
